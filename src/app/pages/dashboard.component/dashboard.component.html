@if (isLoading()) {
<div class="d-flex justify-content-center py-4">
  <div class="spinner-border text-dark" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
} @else {
<div class="container-fluid py-4">
  <!-- Options -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label fw-bold" for="siteSelect">Site</label>
      <ng-select
        id="siteSelect"
        aria-label="Select Site"
        [items]="sites()"
        bindLabel="siteName"
        bindValue="siteId"
        [(ngModel)]="selectedSite"
        (change)="onSiteChange($event)"
        [searchable]="true"
        placeholder="Select site..."
      ></ng-select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold" for="buildingSelect">Building</label>
      <ng-select
        id="buildingSelect"
        aria-label="Select Building"
        [items]="buildings()"
        bindLabel="buildingName"
        bindValue="buildingId"
        [(ngModel)]="selectedBuilding"
        (change)="onBuildingChange($event)"
        [searchable]="true"
        placeholder="Select building..."
      ></ng-select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold" for="floorSelect">Floor</label>
      <ng-select
        id="floorSelect"
        aria-label="Select Floor"
        [items]="floors()"
        bindLabel="floorNo"
        bindValue="floorId"
        [(ngModel)]="selectedFloor"
        (change)="onFloorChange($event)"
        [searchable]="true"
        placeholder="Select floor..."
      ></ng-select>
    </div>
  </div>
  <!-- Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="text-muted">Total spots</h6>
          <h4 class="fw-bold">{{ totalSpots() }}</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="text-muted">Available spots</h6>
          <h4 class="fw-bold text-success">{{ availableSpots() }}</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="text-muted">Unavailable spots</h6>
          <h4 class="fw-bold text-danger">{{ unavailableSpots() }}</h4>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="text-muted">Occupancy rate</h6>
          <h4 class="fw-bold">{{ occupancyRate() }}%</h4>
        </div>
      </div>
    </div>
  </div>
  <!-- Parking layout -->
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0 fw-bold">Parking spots</h5>
    </div>
    <div class="card-body">
      @if (parkingSpots().length > 0) {
      <div class="row g-2">
        @for (spot of parkingSpots(); track spot) { @let info =
        spotInformation().get(spot);
        <div class="col-6 col-sm-4 col-md-2 d-flex align-items-stretch">
          <div
            class="card parking-card w-100 p-2"
            [ngClass]="info ? 'occupied' : 'available'"
          >
            <div class="mb-2 text-center">
              <h6 class="fw-bold mb-1">Spot #{{ spot }}</h6>
              @if (info) {
              <small class="d-block">{{ info.vehicleNo }}</small>
              <small class="d-block">{{ info.custMobileNo }}</small>
              }
            </div>
            <div class="d-flex gap-1 justify-content-center flex-wrap">
              @if (!info) {
              <button
                class="btn btn-sm btn-success"
                (click)="openReserveModal(spot)"
                aria-label="Reserve Spot {{ spot }}"
              >
                Reserve
              </button>
              } @else {
              <button
                class="btn btn-sm btn-danger"
                (click)="openReleaseModal(spot)"
                aria-label="Release Spot {{ spot }}"
              >
                Release
              </button>
              }
            </div>
          </div>
        </div>
        }
      </div>
      } @else {
      <p class="text-muted">No parking spots available.</p>
      }
    </div>
  </div>
  <!-- Reserve -->
  @if (showReserveModal()) {
  <div class="modal" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Spot #{{ selectedReserve }}</h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeReserveModal()"
          ></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="spotForm">
            <div class="mb-3">
              <label class="form-label">VIN</label>
              <div class="input-group">
                <span class="input-group-text border-secondary"
                  ><i class="bi bi-car-front-fill"></i
                ></span>
                <input
                  type="text"
                  class="form-control border-secondary"
                  formControlName="vehicleNo"
                  placeholder="Enter the VIN"
                />
              </div>
              @if (hasError('vehicleNo', 'required')) {
              <span class="text-danger" aria-live="polite">
                VIN required.
              </span>
              } @if (hasError('vehicleNo', 'minlength')) {
              <span class="text-danger" aria-live="polite">
                VIN must be at least 3 characters.
              </span>
              }
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <div class="input-group">
                <span class="input-group-text border-secondary"
                  ><i class="bi bi-telephone-fill"></i
                ></span>
                <input
                  type="text"
                  class="form-control border-secondary"
                  formControlName="custMobileNo"
                  placeholder="Enter the phone"
                />
              </div>
              @if (hasError('custMobileNo', 'required')) {
              <span class="text-danger" aria-live="polite">
                Phone required.
              </span>
              } @if (hasError('custMobileNo', 'minlength')) {
              <span class="text-danger" aria-live="polite">
                Phone must be at least 3 characters.
              </span>
              }
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeReserveModal()">
            Cancel
          </button>
          <button
            class="btn btn-success"
            [disabled]="spotForm.invalid"
            (click)="onReserve()"
          >
            Reserve
          </button>
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Release -->
  @if (showReleaseModal()) {
  <div
    class="modal"
    tabindex="-1"
    role="dialog"
    aria-modal="true"
    (click)="closeReleaseModal()"
  >
    <div
      class="modal-dialog modal-dialog-centered modal-sm"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Release spot</h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeReleaseModal()"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to release the
            <strong>spot #{{ selectedRelease }}</strong
            >?
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeReleaseModal()">
            Cancel
          </button>
          <button class="btn btn-danger" (click)="onRelease()">Release</button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
}
